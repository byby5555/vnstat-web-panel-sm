<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>ç½‘ç»œæµé‡ç›‘æ§é¢æ¿</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg1:#0b0f1b; --bg2:#111827;
      --bgGlow1: rgba(96,165,250,.25);
      --bgGlow2: rgba(167,139,250,.22);

      --cardA: rgba(255,255,255,.08);
      --cardB: rgba(255,255,255,.04);
      --cardBorder: rgba(255,255,255,.12);
      --cardHighlight: rgba(255,255,255,.12);

      --text:#eef2ff; --muted:#94a3b8;

      --accent:#60a5fa; --accent2:#8b5cf6;
      --neon:#38bdf8;
      --good:#34d399; --warn:#fbbf24; --bad:#f87171;

      --shadow: 0 22px 50px rgba(2,6,23,.55);
      --shadowSoft: 0 8px 20px rgba(2,6,23,.35);
      --radius:18px;

      --preBg:#0b1120; --preText:#d1fae5;
      --imgBorder: rgba(255,255,255,.14);

      --axis: rgba(226,232,240,.28);
      --grid: rgba(226,232,240,.12);
      --legend: #dbeafe;
      --tooltipBg: rgba(15,23,42,.92);
      --tooltipBorder: rgba(255,255,255,.14);
    }

    [data-theme="light"]{
      --bg1:#f3f5fb; --bg2:#e8effc;
      --bgGlow1: rgba(59,130,246,.18);
      --bgGlow2: rgba(139,92,246,.16);

      --cardA: rgba(255,255,255,.92);
      --cardB: rgba(255,255,255,.75);
      --cardBorder: rgba(15,23,42,.10);
      --cardHighlight: rgba(15,23,42,.06);

      --text:#0f172a; --muted:#64748b;

      --accent:#2563eb; --accent2:#7c3aed;
      --neon:#0ea5e9;
      --good:#16a34a; --warn:#d97706; --bad:#dc2626;

      --shadow: 0 16px 40px rgba(15,23,42,.12);
      --shadowSoft: 0 8px 18px rgba(15,23,42,.10);

      --preBg:#0f172a; --preText:#d1fae5;
      --imgBorder: rgba(15,23,42,.12);

      --axis: rgba(15,23,42,.25);
      --grid: rgba(15,23,42,.10);
      --legend: #1f2a44;
      --tooltipBg: rgba(255,255,255,.96);
      --tooltipBorder: rgba(15,23,42,.12);
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:24px;
      font-family: "SF Pro Text", "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 10% -10%, var(--bgGlow1), transparent 55%),
        radial-gradient(1100px 520px at 95% 0%, var(--bgGlow2), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      position:relative;
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
    }
    body::before{
      content:"";
      position:fixed;
      inset:-20%;
      background:
        radial-gradient(320px 260px at 15% 20%, rgba(96,165,250,.20), transparent 60%),
        radial-gradient(260px 220px at 85% 15%, rgba(139,92,246,.18), transparent 60%),
        repeating-linear-gradient(90deg, rgba(255,255,255,.04) 0 1px, transparent 1px 120px),
        repeating-linear-gradient(0deg, rgba(255,255,255,.03) 0 1px, transparent 1px 120px);
      opacity:.6;
      pointer-events:none;
      animation: drift 18s linear infinite;
      mix-blend-mode: screen;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background: radial-gradient(600px 420px at 50% -10%, rgba(62,231,255,.15), transparent 60%);
      pointer-events:none;
      opacity:.55;
      mix-blend-mode: screen;
    }

    .container{max-width:1100px;margin:0 auto;position:relative;z-index:1}
    .topbar{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;flex-wrap:wrap;
      margin-bottom:18px;
    }
    .title{display:flex;gap:12px;align-items:center;}
    .title-meta{display:flex;flex-direction:column;gap:6px}
    .logo{
      width:46px;height:46px;border-radius:16px;
      background: linear-gradient(135deg, rgba(96,165,250,.98), rgba(139,92,246,.98));
      box-shadow: 0 16px 34px rgba(59,130,246,.28), 0 0 22px rgba(56,189,248,.25);
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:white;
      position:relative;
      overflow:hidden;
      animation: float 6s ease-in-out infinite;
    }
    .logo::after{
      content:"";
      position:absolute;inset:0;
      background: linear-gradient(135deg, rgba(255,255,255,.35), transparent 60%);
      opacity:.35;
    }
    h1{margin:0;font-size:20px;letter-spacing:.2px}
    .subtitle{margin-top:4px;color:var(--muted);font-size:13px}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      background: linear-gradient(135deg, rgba(96,165,250,.22), rgba(139,92,246,.18));
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;color:var(--text);
      letter-spacing:.2px;
      width:fit-content;
      box-shadow: 0 10px 20px rgba(59,130,246,.18), 0 0 16px rgba(56,189,248,.20);
    }

    .status{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      padding:10px 12px;border:1px solid var(--cardBorder);border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
      box-shadow: var(--shadowSoft);
      backdrop-filter: blur(14px);
    }
    [data-theme="light"] .status{background: rgba(255,255,255,.65);}

    .pill{
      display:flex;gap:8px;align-items:center;
      padding:6px 10px;border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid var(--cardBorder);
      font-size:12px;color:var(--muted);
      white-space:nowrap;
    }
    .k{color:var(--text);font-weight:700}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--good);box-shadow:0 0 0 4px rgba(55,214,122,.12)}
    .dot.warn{background:var(--warn);box-shadow:0 0 0 4px rgba(245,197,66,.16)}
    .dot.bad{background:var(--bad);box-shadow:0 0 0 4px rgba(255,77,79,.16)}

    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--cardBorder);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      margin-bottom:16px;
      overflow:hidden;
      position:relative;
      transition: transform .2s ease, box-shadow .2s ease;
      backdrop-filter: blur(16px);
    }
    .card::before{
      content:"";
      position:absolute;inset:0;
      border-radius:inherit;
      border:1px solid var(--cardHighlight);
      mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      mask-composite: exclude;
      -webkit-mask-composite: xor;
      pointer-events:none;
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow: 0 26px 60px rgba(2,6,23,.55);
    }
    .cardhead{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;flex-wrap:wrap;margin-bottom:10px;
    }
    .cardhead h2{margin:0;font-size:15px}
    .hint{color:var(--muted);font-size:12px;line-height:1.6;margin-top:8px}

    .seg{
      display:inline-flex;
      border:1px solid var(--cardBorder);
      background: rgba(255,255,255,.08);
      border-radius:999px;
      padding:4px;
      gap:4px;
    }
    [data-theme="light"] .seg{ background: rgba(255,255,255,.75); }
    .seg button{
      border:0;background: transparent;color: var(--muted);
      padding:8px 12px;border-radius:999px;cursor:pointer;font-size:12px;
      transition: .15s ease; white-space:nowrap;
    }
    .seg button:hover{color:var(--text);background: rgba(255,255,255,.12)}
    .seg button.active{
      color:#ffffff;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 22px rgba(59,130,246,.18), 0 0 18px rgba(56,189,248,.28);
    }

    select{
      border:1px solid var(--cardBorder);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      outline:none;
    }
    [data-theme="light"] select{ background: rgba(255,255,255,.75); }
    option{ color:#111; }

    .linkbtn{
      border:1px solid var(--cardBorder);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      transition: .2s ease;
    }
    .linkbtn:hover{
      background: rgba(255,255,255,.12);
      box-shadow: 0 0 14px rgba(56,189,248,.25);
    }

    #chart{
      width:100%;height:440px;margin-top:8px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent 60%);
    }
    .small{color:var(--muted);font-size:12px;margin-top:10px}

    pre{
      margin:0;
      background: linear-gradient(180deg, rgba(15,23,42,.95), rgba(15,23,42,.75));
      border:1px solid var(--cardBorder);
      color: var(--preText);
      padding:14px;
      border-radius:14px;
      overflow:auto;
      font-size:12px;
      line-height:1.55;
      white-space:pre;
    }

    .png-item{margin-top:14px}
    .png-title{margin:0 0 8px;font-size:13px;color:var(--text)}
    .png-img{
      display:block;
      width:760px;
      max-width:100%;
      height:auto;
      border-radius:14px;
      border:1px solid var(--imgBorder);
      box-shadow: var(--shadowSoft);
      background: rgba(255,255,255,.04);
    }

    .footer{text-align:center;color:var(--muted);font-size:12px;margin-top:14px;}

    @media (max-width:520px){
      body{padding:14px}
      #chart{height:380px}
    }

    /* Modal */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal{
      width:min(760px, 100%);
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid var(--cardBorder);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:16px;
      backdrop-filter: blur(16px);
      max-height: min(80vh, 760px);
      overflow:auto;
    }
    .modal h3{margin:0 0 12px 0;font-size:14px}
    .field{margin:10px 0}
    .field label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    .field input{
      width:100%;
      border:1px solid var(--cardBorder);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding:10px 12px;
      border-radius:12px;
      outline:none;
      font-size:13px;
    }
    [data-theme="light"] .field input{ background: rgba(255,255,255,.75); }
    .field .checkbox-row{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:var(--muted);
    }
    .field .checkbox-row input{ accent-color: var(--accent); }
    .field small{display:block;margin-top:6px;color:var(--muted);font-size:11px}
    .column-title{
      font-size:13px;
      font-weight:600;
      color:var(--text);
      margin-bottom:4px;
    }
    .field input.error{
      border-color: var(--bad);
      box-shadow: 0 0 0 2px rgba(248,113,113,.2);
    }
    .form-columns{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:16px;
    }
    .form-columns .column{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .form-columns .field{margin:0}
    @media (max-width:720px){
      .form-columns{grid-template-columns: 1fr;}
    }
    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
    .btn{
      border:1px solid var(--cardBorder);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
    }
    .btn.primary{
      border:0;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;
      box-shadow: 0 10px 22px rgba(59,130,246,.18), 0 0 20px rgba(56,189,248,.24);
    }
    .btn:hover{ background: rgba(255,255,255,.12); }
    .btn.primary:hover{ filter: brightness(1.05); }
    .tiny{color:var(--muted);font-size:12px;line-height:1.6}
    .tiny.error{color:var(--bad);}

    @keyframes drift{
      0%{ transform: translate3d(0,0,0) scale(1); }
      50%{ transform: translate3d(-2%, -1%, 0) scale(1.02); }
      100%{ transform: translate3d(0,0,0) scale(1); }
    }
    @keyframes float{
      0%{ transform: translateY(0); }
      50%{ transform: translateY(-4px); }
      100%{ transform: translateY(0); }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>

<body>
<div class="container">

  <div class="topbar">
    <div class="title">
      <div class="logo">VN</div>
      <div class="title-meta">
        <h1>ç½‘ç»œæµé‡ç›‘æ§é¢æ¿</h1>
        <span class="badge" id="uiVersion">UI v2 Â· loadingâ€¦</span>
        <div class="subtitle">vnStat æ•°æ® + äº¤äº’å›¾è¡¨ï¼ˆæ»šè½®ç¼©æ”¾ / å¹³ç§»ï¼‰</div>
      </div>
    </div>

    <div class="status">
      <div class="pill">
        <span id="statusDot" class="dot"></span>
        <span>çŠ¶æ€</span>
        <span class="k" id="statusText">è¿è¡Œä¸­</span>
      </div>

      <div class="pill">ç½‘å¡ï¼š<span class="k" id="ifaceName">eth0</span></div>
      <div class="pill">è§†å›¾ï¼š<span class="k" id="viewName">æµé‡</span></div>
      <div class="pill">ç²’åº¦ï¼š<span class="k" id="modeName">å°æ—¶</span></div>
      <div class="pill">æ›´æ–°æ—¶é—´ï¼š<span class="k" id="lastUpdate">-</span></div>

      <!-- âœ… VPS/æµè§ˆå™¨æ—¶é—´æ—¶åŒºæ˜¾ç¤ºï¼ˆæ–°å¢ä½†ä¸ç ´åå¸ƒå±€ï¼‰ -->
      <div class="pill" title="æ¥è‡ªæœåŠ¡å™¨ server_time.json">VPSï¼š<span class="k" id="serverClock">-</span></div>
      <div class="pill" title="æ¥è‡ªæµè§ˆå™¨æœ¬åœ°æ—¶é—´/æ—¶åŒº">æµè§ˆå™¨ï¼š<span class="k" id="browserClock">-</span></div>

      <!-- âœ… æœ¬æœˆç”¨é‡/é¢åº¦/ç™¾åˆ†æ¯”ï¼ˆå‘Šè­¦ï¼‰ -->
      <div class="pill" id="quotaPill" title="ä» vnstat.json è¯»å–æœ¬æœˆæ€»é‡ï¼ˆrx+txï¼‰è®¡ç®—">
        æœ¬æœˆï¼š<span class="k" id="monthUsage">-</span>
        <span style="opacity:.8">/</span>
        <span class="k" id="monthQuota">-</span>
        <span style="opacity:.8">ï¼ˆ</span><span class="k" id="monthPct">-</span><span style="opacity:.8">ï¼‰</span>
      </div>

      <button class="linkbtn" id="btnQuota">é˜ˆå€¼è®¾ç½®</button>

      <div class="pill">
        ä¸»é¢˜ï¼š
        <select id="themeSelect" title="ä¸»é¢˜åˆ‡æ¢">
          <option value="auto">è‡ªåŠ¨</option>
          <option value="light">ç™½å¤©</option>
          <option value="dark">å¤œé—´</option>
        </select>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="cardhead">
      <h2>ğŸ“ˆ äº¤äº’å›¾è¡¨</h2>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <div class="seg" aria-label="view toggle">
          <button id="btn_view_traffic" class="active">æµé‡(æ€»é‡)</button>
          <button id="btn_view_rate">å¸¦å®½(å¹³å‡)</button>
        </div>

        <div class="seg" aria-label="mode toggle">
          <button id="btn_5min">5åˆ†é’Ÿ</button>
          <button id="btn_hour" class="active">å°æ—¶</button>
          <button id="btn_day">å¤©</button>
          <button id="btn_month">æœˆ</button>
        </div>
      </div>
    </div>

    <div class="hint">
      å¸¦å®½(å¹³å‡)=æ¯ä¸ªæ—¶é—´æ¡¶å†…çš„æµé‡ Ã· æ—¶é—´æ¡¶é•¿åº¦ï¼ˆ5åˆ†é’Ÿ/å°æ—¶/å¤©/æœˆï¼‰ï¼Œç”¨äºè§‚å¯Ÿè¶‹åŠ¿ï¼ˆä¸æ˜¯ç§’çº§å®æ—¶ï¼‰ã€‚
    </div>

    <div id="chart"></div>
    <div class="small" id="chartUpdated">å›¾è¡¨æœ€ååˆ·æ–°ï¼š-</div>
  </div>

  <div class="card">
    <div class="cardhead">
      <h2>ğŸ“„ å½“å‰ç»Ÿè®¡æ‘˜è¦</h2>
      <div class="pill">è‡ªåŠ¨åˆ·æ–°ï¼š<span class="k">60 ç§’</span></div>
    </div>
    <pre id="summary">åŠ è½½ä¸­...</pre>
    <div class="small" id="updated">æœ€ååˆ·æ–°ï¼š-</div>
  </div>

  <div class="card">
    <div class="cardhead">
      <h2>ğŸ–¼ PNG å¤‡ç”¨å›¾</h2>
      <div class="pill">ç”¨äºå¯¹ç…§ï¼ˆéäº¤äº’ï¼‰</div>
    </div>

    <div class="png-item">
      <div class="png-title">å°æ—¶</div>
      <img id="img_hourly" class="png-img" src="hourly.png" alt="å°æ—¶æµé‡">
    </div>

    <div class="png-item">
      <div class="png-title">æ¯æ—¥</div>
      <img id="img_daily" class="png-img" src="daily.png" alt="æ¯æ—¥æµé‡">
    </div>

    <div class="png-item">
      <div class="png-title">æ¯æœˆ</div>
      <img id="img_monthly" class="png-img" src="monthly.png" alt="æ¯æœˆæµé‡">
    </div>
  </div>

  <div class="footer">æ•°æ®æ¥æºï¼švnStat ï½œ å»ºè®®åå° 5 åˆ†é’Ÿæ›´æ–° vnstat_5min.json / vnstat.json</div>
</div>

<!-- é˜ˆå€¼è®¾ç½®å¼¹çª— -->
<div class="modalMask" id="quotaMask">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>ğŸš¦ æµé‡é˜ˆå€¼å‘Šè­¦ï¼ˆä»…é¡µé¢æç¤ºï¼‰</h3>

    <div class="form-columns">
      <div class="column">
        <div class="column-title">é˜ˆå€¼å‚æ•°</div>
        <div class="field">
          <label>æœ¬æœˆæ€»é¢åº¦ï¼ˆGBï¼‰</label>
          <input id="q_quota_gb" type="number" min="1" step="1" />
        </div>

        <div class="field">
          <label>å‘Šè­¦é˜ˆå€¼ï¼ˆ%ï¼‰</label>
          <input id="q_alert_pct" type="number" min="1" max="100" step="1" />
        </div>

        <div class="field">
          <label>å±é™©é˜ˆå€¼ï¼ˆ%ï¼‰</label>
          <input id="q_danger_pct" type="number" min="1" max="100" step="1" />
        </div>

        <div class="field">
          <label>æ¯æœˆæµé‡èµ·ç®—æ—¥ï¼ˆ1-31ï¼‰</label>
          <input id="q_month_start_day" type="number" min="1" max="31" step="1" />
          <small>ä¾‹å¦‚å¡« 15 è¡¨ç¤ºæ¯æœˆ 15 å·èµ·ç®—ç»Ÿè®¡ã€‚</small>
        </div>

        <div class="field">
          <label>è‡ªåŠ¨å…³æœºï¼ˆåˆ°è¾¾å…³æœºé˜ˆå€¼ï¼‰</label>
          <div class="checkbox-row">
            <input id="q_auto_shutdown" type="checkbox" />
            <span>è¾¾åˆ°é˜ˆå€¼è‡ªåŠ¨å…³æœº</span>
          </div>
          <input id="q_shutdown_pct" type="number" min="1" max="100" step="1" />
          <small>å…³æœºé˜ˆå€¼ç™¾åˆ†æ¯”ï¼ˆå»ºè®®é«˜äºå±é™©é˜ˆå€¼ï¼‰ã€‚</small>
        </div>
      </div>

      <div class="column">
        <div class="column-title">é€šçŸ¥ä¸è®¤è¯</div>
        <div class="field">
          <label>Telegram é€šçŸ¥</label>
          <div class="checkbox-row">
            <input id="q_tg_enabled" type="checkbox" />
            <span>å¯ç”¨ Telegram Bot å‘Šè­¦/å…³æœºé€šçŸ¥</span>
          </div>
          <input id="q_tg_bot_token" type="password" placeholder="Bot Token" />
          <input id="q_tg_chat_id" type="text" placeholder="Chat ID" />
          <small>å¡«å†™ Bot Token ä¸ Chat ID åä¼šæ¨é€å‘Šè­¦/å…³æœºä¿¡æ¯ã€‚</small>
        </div>

        <div class="field">
          <label>ä¿å­˜éœ€è¦ Token</label>
          <input id="q_token" type="password" placeholder="å®‰è£…æ—¶ç”Ÿæˆçš„ Token" />
          <small>æœªé€šè¿‡ Token è®¤è¯å°†æ— æ³•ä¿å­˜ã€‚</small>
        </div>
      </div>
    </div>

    <div class="tiny" id="quotaHint">
      ä¿å­˜åï¼š<b>é»„ç¯=å‘Šè­¦</b>ï¼Œ<b>çº¢ç¯=å±é™©</b>ã€‚å¿…é¡»ä½¿ç”¨ Token ä¿å­˜åˆ°æœåŠ¡å™¨ã€‚
    </div>

    <div class="actions">
      <button class="btn" id="btnQuotaCancel">å–æ¶ˆ</button>
      <button class="btn primary" id="btnQuotaSave">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
  const IFACE_NAME = "auto";
  const THEME_KEY = "vnstat_theme_pref";

  const QUOTA_URL = "quota.json";
  const QUOTA_API = "cgi-bin/vnstat-web-config.cgi";
  const QUOTA_LOCAL_KEY = "vnstat_quota_settings";
  const QUOTA_TOKEN_KEY = "vnstat_quota_token";

  let view = 'traffic'; // traffic | rate
  let mode = 'hour';    // fivemin | hour | day | month
  let chart;

  document.getElementById('ifaceName').textContent = IFACE_NAME === 'auto' ? 'è‡ªåŠ¨' : IFACE_NAME;

  function isDaytimeByBrowser(){
    const h = new Date().getHours();
    return h >= 7 && h < 19;
  }
  function applyTheme(mode){
    let t = mode;
    if (t === 'auto') t = isDaytimeByBrowser() ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', t);
    if (chart) { chart.dispose(); chart=null; refreshChart(); }
  }
  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY) || 'auto';
    const sel = document.getElementById('themeSelect');
    sel.value = saved;
    applyTheme(saved);
    sel.addEventListener('change', () => {
      localStorage.setItem(THEME_KEY, sel.value);
      applyTheme(sel.value);
    });
  }

  function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  function setStatus(level, text){
    const dot = document.getElementById('statusDot');
    dot.className = 'dot';
    if(level === 'warn') dot.classList.add('warn');
    if(level === 'bad') dot.classList.add('bad');
    document.getElementById('statusText').textContent = text;
  }

  function setStatusText(){
    document.getElementById('viewName').textContent = (view === 'traffic') ? "æµé‡" : "å¸¦å®½";
    const map = {fivemin:"5åˆ†é’Ÿ", hour:"å°æ—¶", day:"å¤©", month:"æœˆ"};
    document.getElementById('modeName').textContent = map[mode] || mode;
  }

  function refreshImages() {
    const t = Date.now();
    document.getElementById('img_hourly').src  = 'hourly.png?_=' + t;
    document.getElementById('img_daily').src   = 'daily.png?_=' + t;
    document.getElementById('img_monthly').src = 'monthly.png?_=' + t;
  }

  function refreshSummary() {
    fetch('summary.txt?_=' + Date.now())
      .then(r => r.text())
      .then(t => {
        document.getElementById('summary').textContent = t;
        document.getElementById('updated').textContent = 'æœ€ååˆ·æ–°ï¼š' + new Date().toLocaleString();
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
      })
      .catch(() => {
        document.getElementById('summary').textContent = 'è¯»å– summary.txt å¤±è´¥ï¼ˆè¯·æ£€æŸ¥æ–‡ä»¶æƒé™æˆ–è·¯å¾„ï¼‰';
      });
  }

  function formatBytes(v) {
    const n = Number(v);
    if (!isFinite(n)) return String(v);
    const abs = Math.abs(n);
    const units = ['B','KB','MB','GB','TB','PB'];
    let u = 0;
    let val = abs;
    while (val >= 1024 && u < units.length - 1) { val /= 1024; u++; }
    const out = (n < 0 ? -val : val);
    return `${out.toFixed(u === 0 ? 0 : 2)} ${units[u]}`;
  }

  function formatBps(v) {
    const n = Number(v);
    if (!isFinite(n)) return String(v);
    const abs = Math.abs(n);
    const units = ['bps','Kbps','Mbps','Gbps','Tbps'];
    let u = 0;
    let val = abs;
    while (val >= 1000 && u < units.length - 1) { val /= 1000; u++; }
    const out = (n < 0 ? -val : val);
    return `${out.toFixed(u === 0 ? 0 : 2)} ${units[u]}`;
  }

  function bucketSecondsFor(mode, label) {
    if (mode === 'fivemin') return 5 * 60;
    if (mode === 'hour') return 60 * 60;
    if (mode === 'day') return 24 * 60 * 60;
    if (mode === 'month') {
      const parts = String(label).split('-');
      const y = Number(parts[0] || 0);
      const m = Number(parts[1] || 0);
      if (y > 1970 && m >= 1 && m <= 12) {
        const days = new Date(y, m, 0).getDate();
        return days * 86400;
      }
      return 30 * 86400;
    }
    return 3600;
  }

  function renderChart(series, modeForBucket) {
    if (!chart) chart = echarts.init(document.getElementById('chart'));

    let yFormatter = formatBytes;
    let tooltipFormatter = formatBytes;

    let legend = ['ä¸‹è¡Œ(rx)','ä¸Šè¡Œ(tx)','æ€»è®¡'];
    let s1 = series.rx, s2 = series.tx, s3 = series.total;
    let yName = '';

    if (view === 'rate') {
      const rxBps = [], txBps = [], totalBps = [];
      for (let i=0;i<series.labels.length;i++) {
        const sec = bucketSecondsFor(modeForBucket, series.labels[i]);
        const r = (Number(series.rx[i]) || 0) * 8 / sec;
        const t = (Number(series.tx[i]) || 0) * 8 / sec;
        rxBps.push(r); txBps.push(t); totalBps.push(r + t);
      }
      yFormatter = formatBps;
      tooltipFormatter = formatBps;
      legend = ['ä¸‹è¡Œ å¹³å‡é€Ÿç‡','ä¸Šè¡Œ å¹³å‡é€Ÿç‡','æ€»è®¡ å¹³å‡é€Ÿç‡'];
      s1 = rxBps; s2 = txBps; s3 = totalBps;
      yName = 'å¹³å‡å¸¦å®½';
    }

    const axis = cssVar('--axis');
    const grid = cssVar('--grid');
    const legendColor = cssVar('--legend');
    const tooltipBg = cssVar('--tooltipBg');
    const tooltipBorder = cssVar('--tooltipBorder');

    chart.setOption({
      backgroundColor: 'transparent',
      tooltip: {
        trigger: 'axis',
        confine: true,
        valueFormatter: (v) => tooltipFormatter(v),
        backgroundColor: tooltipBg,
        borderColor: tooltipBorder,
        borderWidth: 1,
        textStyle: { color: cssVar('--text') },
        extraCssText: 'border-radius:12px; box-shadow: 0 14px 30px rgba(0,0,0,.18);'
      },
      legend: { data: legend, textStyle: { color: legendColor } },
      grid: { left: 18, right: 18, top: 58, bottom: 62, containLabel: true },
      xAxis: {
        type: 'category',
        data: series.labels,
        boundaryGap: false,
        axisLine: { lineStyle: { color: axis } },
        axisLabel: { color: cssVar('--muted') }
      },
      yAxis: {
        type: 'value',
        name: yName,
        nameTextStyle: { color: cssVar('--muted') },
        axisLine: { lineStyle: { color: axis } },
        axisLabel: { color: cssVar('--muted'), formatter: (v) => yFormatter(v) },
        splitLine: { lineStyle: { color: grid } }
      },
      dataZoom: [
        { type: 'inside', xAxisIndex: 0, filterMode: 'none' },
        {
          type: 'slider', xAxisIndex: 0, height: 22, bottom: 18,
          borderColor: cssVar('--cardBorder'),
          fillerColor: 'rgba(78,161,255,.22)',
          backgroundColor: 'rgba(255,255,255,.06)',
          textStyle: { color: cssVar('--muted') }
        }
      ],
      series: [
        { name: legend[0], type: 'line', showSymbol: false, data: s1, smooth: true, lineStyle:{width:2} },
        { name: legend[1], type: 'line', showSymbol: false, data: s2, smooth: true, lineStyle:{width:2} },
        { name: legend[2], type: 'line', showSymbol: false, data: s3, smooth: true, lineStyle:{width:2, opacity:.85} }
      ]
    }, true);

    document.getElementById('chartUpdated').textContent = 'å›¾è¡¨æœ€ååˆ·æ–°ï¼š' + new Date().toLocaleString();
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
  }

  function pickInterface(vn){
    const list = Array.isArray(vn.interfaces) ? vn.interfaces : [];
    if (!list.length) return null;
    if (IFACE_NAME && IFACE_NAME !== 'auto') {
      const matched = list.find((item) => item && item.name === IFACE_NAME);
      if (matched) return matched;
    }
    return list.find((item) => item && item.traffic) || list[0];
  }

  function updateIfaceLabel(iface){
    if (!iface || !iface.name) return;
    document.getElementById('ifaceName').textContent = iface.name;
  }

  function pickSeriesFromVnstatJson(vn, pickMode) {
    const iface = pickInterface(vn);
    if (!iface || !iface.traffic) return null;
    updateIfaceLabel(iface);

    let key = pickMode;
    if (!iface.traffic[key]) {
      if (pickMode === 'hour' && iface.traffic.hours) key = 'hours';
      if (pickMode === 'day' && iface.traffic.days) key = 'days';
      if (pickMode === 'month' && iface.traffic.months) key = 'months';
    }
    if (!iface.traffic[key]) return null;

    const arr = iface.traffic[key];
    const labels = [], rx = [], tx = [], total = [];

    for (const item of arr) {
      let label = '';
      if (pickMode === 'hour') {
        const d = item.date || {};
        const tm = item.time || {};
        const mm = String(d.month ?? '').padStart(2,'0');
        const dd = String(d.day ?? '').padStart(2,'0');
        const hh = String(tm.hour ?? '').padStart(2,'0');
        label = `${mm}-${dd} ${hh}:00`;
      } else if (pickMode === 'day') {
        const d = item.date || {};
        const yy = d.year ?? '';
        const mm = String(d.month ?? '').padStart(2,'0');
        const dd = String(d.day ?? '').padStart(2,'0');
        label = `${yy}-${mm}-${dd}`;
      } else {
        const d = item.date || {};
        const yy = d.year ?? '';
        const mm = String(d.month ?? '').padStart(2,'0');
        label = `${yy}-${mm}`;
      }

      const r = item.rx ?? item.rx_bytes ?? 0;
      const t = item.tx ?? item.tx_bytes ?? 0;

      labels.push(label);
      rx.push(r);
      tx.push(t);
      total.push((Number(r) || 0) + (Number(t) || 0));
    }
    return { labels, rx, tx, total };
  }

  function pickSeriesFrom5MinJson(vn) {
    const iface = pickInterface(vn);
    if (!iface || !iface.traffic) return null;
    updateIfaceLabel(iface);

    // âœ… vnstat 2.10: traffic.fiveminute
    const arr = iface.traffic.fiveminute || iface.traffic.fivemin || iface.traffic.fiveminutes || iface.traffic.f || null;
    if (!arr) return null;

    const labels = [], rx = [], tx = [], total = [];

    for (const item of arr) {
      const d = item.date || {};
      const t = item.time || {};
      const mm = String(d.month ?? '').padStart(2,'0');
      const dd = String(d.day ?? '').padStart(2,'0');
      const hh = String(t.hour ?? '').padStart(2,'0');
      const mi = String(t.minute ?? '').padStart(2,'0');
      labels.push(`${mm}-${dd} ${hh}:${mi}`);

      const r = item.rx ?? item.rx_bytes ?? 0;
      const x = item.tx ?? item.tx_bytes ?? 0;
      rx.push(r);
      tx.push(x);
      total.push((Number(r) || 0) + (Number(x) || 0));
    }
    return { labels, rx, tx, total };
  }

  function showChartError(msg){
    document.getElementById('chart').innerHTML =
      '<div style="padding:12px;color:#ff6b6b;font-size:13px;line-height:1.6">è¯»å–å¤±è´¥ï¼š' + msg + '</div>';
  }

  function refreshChart() {
    if (mode === 'fivemin') {
      fetch('vnstat_5min.json?_=' + Date.now())
        .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
        .then(vn => {
          const series = pickSeriesFrom5MinJson(vn);
          if (!series) throw new Error('vnstat_5min.json ä¸­æ‰¾ä¸åˆ° 5 åˆ†é’Ÿå­—æ®µï¼ˆtraffic.fiveminuteï¼‰');
          renderChart(series, 'fivemin');
        })
        .catch(err => showChartError(err.message || err));
      return;
    }

    fetch('vnstat.json?_=' + Date.now())
      .then(r => { if(!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(vn => {
        const series = pickSeriesFromVnstatJson(vn, mode);
        if (!series) throw new Error('vnstat.json ä¸­æ‰¾ä¸åˆ°å­—æ®µï¼štraffic.' + mode);
        renderChart(series, mode);
      })
      .catch(err => showChartError(err.message || err));
  }

  function setMode(m) {
    mode = m;
    document.getElementById('btn_5min').classList.toggle('active', m === 'fivemin');
    document.getElementById('btn_hour').classList.toggle('active', m === 'hour');
    document.getElementById('btn_day').classList.toggle('active', m === 'day');
    document.getElementById('btn_month').classList.toggle('active', m === 'month');
    setStatusText();
    refreshChart();
  }
  function setView(v) {
    view = v;
    document.getElementById('btn_view_traffic').classList.toggle('active', v === 'traffic');
    document.getElementById('btn_view_rate').classList.toggle('active', v === 'rate');
    setStatusText();
    refreshChart();
  }

  document.getElementById('btn_5min').onclick = () => setMode('fivemin');
  document.getElementById('btn_hour').onclick = () => setMode('hour');
  document.getElementById('btn_day').onclick = () => setMode('day');
  document.getElementById('btn_month').onclick = () => setMode('month');

  document.getElementById('btn_view_traffic').onclick = () => setView('traffic');
  document.getElementById('btn_view_rate').onclick = () => setView('rate');

  // ===== VPS/æµè§ˆå™¨ æ—¶åŒºæ—¶é—´ =====
  function refreshClocks(){
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'unknown';
    document.getElementById('browserClock').textContent =
      new Date().toLocaleString() + ' ' + tz;

    fetch('server_time.json?_=' + Date.now())
      .then(r => r.ok ? r.json() : null)
      .then(j => {
        if(!j) return;
        // åªæ˜¾ç¤ºç²¾ç®€ä¸€ç‚¹ï¼Œé¿å…å¤ªé•¿
        const s = `${j.server_time_iso} ${j.server_tz} (${j.server_utc_offset})`;
        document.getElementById('serverClock').textContent = s;
      })
      .catch(()=>{});
  }

  // ===== é˜ˆå€¼è®¾ç½® =====
  function bytesToGB(bytes){ return (Number(bytes)||0) / 1024 / 1024 / 1024; }

  function getMonthTotalBytes(vn){
    const iface = pickInterface(vn);
    if(!iface || !iface.traffic) return null;
    updateIfaceLabel(iface);

    const monthArr = iface.traffic.month || iface.traffic.months || null;
    if(Array.isArray(monthArr) && monthArr.length){
      const sorted = [...monthArr].sort((a,b)=>{
        const ay=(a.date?.year||0), am=(a.date?.month||0);
        const by=(b.date?.year||0), bm=(b.date?.month||0);
        return (ay*100+am) - (by*100+bm);
      });
      const last = sorted[sorted.length-1];
      const rx = last.rx ?? last.rx_bytes ?? 0;
      const tx = last.tx ?? last.tx_bytes ?? 0;
      return (Number(rx)||0) + (Number(tx)||0);
    }
    return null;
  }

  function getPeriodTotalBytes(vn, startDay){
    const iface = pickInterface(vn);
    if(!iface || !iface.traffic) return null;
    updateIfaceLabel(iface);

    const dayArr = iface.traffic.day || iface.traffic.days || null;
    const start = Number(startDay) || 1;
    if(!Array.isArray(dayArr) || !dayArr.length){
      return getMonthTotalBytes(vn);
    }

    const now = new Date();
    const startDate = new Date(now.getFullYear(), now.getMonth(), start);
    if (now.getDate() < start) {
      startDate.setMonth(startDate.getMonth() - 1);
    }
    const startKey = startDate.getFullYear() * 10000 + (startDate.getMonth() + 1) * 100 + startDate.getDate();

    let total = 0;
    for (const item of dayArr) {
      const d = item.date || {};
      const key = (Number(d.year) || 0) * 10000 + (Number(d.month) || 0) * 100 + (Number(d.day) || 0);
      if (key >= startKey) {
        const rx = item.rx ?? item.rx_bytes ?? 0;
        const tx = item.tx ?? item.tx_bytes ?? 0;
        total += (Number(rx) || 0) + (Number(tx) || 0);
      }
    }
    return total || 0;
  }

  function readQuotaLocal(){
    try{
      const raw = localStorage.getItem(QUOTA_LOCAL_KEY);
      if(!raw) return null;
      const data = JSON.parse(raw);
      if (!data || typeof data !== 'object') return null;
      return data;
    }catch(e){
      return null;
    }
  }

  function saveQuotaLocal(settings){
    const payload = {
      quota_gb: Number(settings.quota_gb),
      alert_pct: Number(settings.alert_pct),
      danger_pct: Number(settings.danger_pct),
      auto_shutdown: Number(settings.auto_shutdown) ? 1 : 0,
      shutdown_pct: Number(settings.shutdown_pct),
      month_start_day: Number(settings.month_start_day),
      tg_enabled: Number(settings.tg_enabled) ? 1 : 0,
      tg_bot_token: settings.tg_bot_token || "",
      tg_chat_id: settings.tg_chat_id || "",
      saved_at: new Date().toISOString()
    };
    localStorage.setItem(QUOTA_LOCAL_KEY, JSON.stringify(payload));
    return payload;
  }

  async function fetchQuotaFile(){
    const r = await fetch(QUOTA_URL + '?_=' + Date.now(), { cache: 'no-store' });
    if(!r.ok) throw new Error('quota.json HTTP ' + r.status);
    return await r.json();
  }

  async function loadQuotaSettings(){
    const local = readQuotaLocal();
    if (local) return local;
    return await fetchQuotaFile();
  }

  function loadQuotaToken(){
    return localStorage.getItem(QUOTA_TOKEN_KEY) || '';
  }

  function saveQuotaToken(token){
    localStorage.setItem(QUOTA_TOKEN_KEY, token);
  }

  function normalizeQuotaSettings(raw){
    const s = raw || {};
    return {
      quota_gb: Number(s.quota_gb) || 1024,
      alert_pct: Number(s.alert_pct) || 90,
      danger_pct: Number(s.danger_pct) || 100,
      auto_shutdown: Number(s.auto_shutdown) ? 1 : 0,
      shutdown_pct: Number(s.shutdown_pct) || 100,
      month_start_day: Number(s.month_start_day) || 1,
      tg_enabled: Number(s.tg_enabled) ? 1 : 0,
      tg_bot_token: s.tg_bot_token || "",
      tg_chat_id: s.tg_chat_id || ""
    };
  }

  async function saveQuotaServer(payload, token){
    const body = { ...payload, token };
    const r = await fetch(QUOTA_API, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    if (!r.ok) throw new Error('ä¿å­˜å¤±è´¥ HTTP ' + r.status);
    const j = await r.json().catch(() => ({}));
    if (!j.ok) {
      if (j.err === 'unauthorized') throw new Error('Token æ— æ•ˆæˆ–ç¼ºå¤±');
      throw new Error(j.err || 'ä¿å­˜å¤±è´¥');
    }
    return j;
  }

  async function refreshQuotaAlarm(){
    let settings;
    try{
      settings = normalizeQuotaSettings(await loadQuotaSettings());
    }catch(e){
      document.getElementById('monthQuota').textContent = '-';
      document.getElementById('monthUsage').textContent = 'é˜ˆå€¼è¯»å–å¤±è´¥';
      document.getElementById('monthPct').textContent = '-';
      return;
    }

    const quotaGb = Number(settings.quota_gb)||1024;
    const alertPct = Number(settings.alert_pct)||90;
    const dangerPct = Number(settings.danger_pct)||100;
    const monthStartDay = Number(settings.month_start_day)||1;

    document.getElementById('monthQuota').textContent = quotaGb + 'GB';

    try{
      const r = await fetch('vnstat.json?_=' + Date.now());
      if(!r.ok) throw new Error('vnstat.json HTTP ' + r.status);
      const vn = await r.json();

      const totalBytes = getPeriodTotalBytes(vn, monthStartDay);
      if(totalBytes == null){
        document.getElementById('monthUsage').textContent = 'æ— æœ¬æœˆæ•°æ®';
        document.getElementById('monthPct').textContent = '-';
        setStatus('ok', 'è¿è¡Œä¸­');
        return;
      }

      const usedGB = bytesToGB(totalBytes);
      const pct = (usedGB / quotaGb) * 100;

      document.getElementById('monthUsage').textContent = usedGB.toFixed(2) + 'GB';
      document.getElementById('monthPct').textContent = isFinite(pct) ? pct.toFixed(1) + '%' : '-';

      if (isFinite(pct) && pct >= dangerPct){
        setStatus('bad', 'å±é™©ï¼šæµé‡æ¥è¿‘/è¶…è¿‡é¢åº¦');
      } else if (isFinite(pct) && pct >= alertPct){
        setStatus('warn', 'å‘Šè­¦ï¼šæµé‡æ¥è¿‘é¢åº¦');
      } else {
        setStatus('ok', 'è¿è¡Œä¸­');
      }

      document.getElementById('quotaPill').title =
        `å·²ç”¨ ${usedGB.toFixed(2)}GB / ${quotaGb}GBï¼ˆ${pct.toFixed(1)}%ï¼‰ èµ·ç®—æ—¥=${monthStartDay}å· å‘Šè­¦>=${alertPct}% å±é™©>=${dangerPct}%`;

    }catch(e){
      document.getElementById('monthUsage').textContent = 'è¯»å–å¤±è´¥';
      document.getElementById('monthPct').textContent = '-';
    }
  }

  // å¼¹çª—
  function openQuotaModal(){
    const hint = document.getElementById('quotaHint');
    hint.textContent = 'è¯»å–è®¾ç½®ä¸­...';
    hint.classList.remove('error');
    document.getElementById('q_token').classList.remove('error');
    document.getElementById('quotaMask').style.display = 'flex';

    loadQuotaSettings().then(raw=>{
      const s = normalizeQuotaSettings(raw);
      document.getElementById('q_quota_gb').value = Number(s.quota_gb)||1024;
      document.getElementById('q_alert_pct').value = Number(s.alert_pct)||90;
      document.getElementById('q_danger_pct').value = Number(s.danger_pct)||100;
      document.getElementById('q_month_start_day').value = Number(s.month_start_day)||1;
      document.getElementById('q_auto_shutdown').checked = Number(s.auto_shutdown) === 1;
      document.getElementById('q_shutdown_pct').value = Number(s.shutdown_pct)||100;
      document.getElementById('q_tg_enabled').checked = Number(s.tg_enabled) === 1;
      document.getElementById('q_tg_bot_token').value = s.tg_bot_token || '';
      document.getElementById('q_tg_chat_id').value = s.tg_chat_id || '';
      document.getElementById('q_token').value = loadQuotaToken();
      hint.innerHTML =
        'ä¿å­˜åï¼š<b>é»„ç¯=å‘Šè­¦</b>ï¼Œ<b>çº¢ç¯=å±é™©</b>ã€‚å¿…é¡»ä½¿ç”¨ Token ä¿å­˜åˆ°æœåŠ¡å™¨ã€‚';
    }).catch(()=>{
      hint.textContent =
        'è¯»å–å¤±è´¥ï¼šæœªæ‰¾åˆ° quota.json æˆ–æµè§ˆå™¨è®¾ç½®';
      hint.classList.add('error');
    });
  }
  function closeQuotaModal(){ document.getElementById('quotaMask').style.display = 'none'; }

  document.getElementById('btnQuota').onclick = openQuotaModal;
  document.getElementById('btnQuotaCancel').onclick = closeQuotaModal;
  document.getElementById('quotaMask').onclick = (e) => {
    if (e.target === document.getElementById('quotaMask')) closeQuotaModal();
  };

  document.getElementById('btnQuotaSave').onclick = async () => {
    const hint = document.getElementById('quotaHint');
    hint.classList.remove('error');
    const quota_gb = Math.max(1, Number(document.getElementById('q_quota_gb').value || 0));
    const alert_pct = Math.min(100, Math.max(1, Number(document.getElementById('q_alert_pct').value || 0)));
    const danger_pct0 = Math.min(100, Math.max(1, Number(document.getElementById('q_danger_pct').value || 0)));
    const danger_pct = Math.max(danger_pct0, alert_pct);
    const month_start_day = Math.min(31, Math.max(1, Number(document.getElementById('q_month_start_day').value || 1)));
    const auto_shutdown = document.getElementById('q_auto_shutdown').checked ? 1 : 0;
    const shutdown_pct = Math.min(100, Math.max(1, Number(document.getElementById('q_shutdown_pct').value || 100)));
    const tg_enabled = document.getElementById('q_tg_enabled').checked ? 1 : 0;
    const tg_bot_token = document.getElementById('q_tg_bot_token').value.trim();
    const tg_chat_id = document.getElementById('q_tg_chat_id').value.trim();
    const token = document.getElementById('q_token').value.trim();
    document.getElementById('q_token').classList.remove('error');

    const payload = {
      quota_gb,
      alert_pct,
      danger_pct,
      auto_shutdown,
      shutdown_pct,
      month_start_day,
      tg_enabled,
      tg_bot_token,
      tg_chat_id
    };

    if (!token) {
      hint.textContent = 'ä¿å­˜å¤±è´¥ï¼šå¿…é¡»å¡«å†™ Tokenã€‚';
      hint.classList.add('error');
      document.getElementById('q_token').classList.add('error');
      return;
    }

    try{
      await saveQuotaServer(payload, token);
      saveQuotaLocal(payload);
      saveQuotaToken(token);
      closeQuotaModal();
    }catch(e){
      hint.textContent = 'ä¿å­˜åˆ°æœåŠ¡å™¨å¤±è´¥ï¼š' + (e.message || e);
      hint.classList.add('error');
      document.getElementById('q_token').classList.add('error');
      return;
    }
    await refreshQuotaAlarm();
  };

  function tick(){
    refreshImages();
    refreshSummary();
    refreshChart();
    refreshClocks();
    refreshQuotaAlarm();
  }

  // åˆå§‹åŒ–
  initTheme();
  setStatusText();
  tick();

  setInterval(tick, 60 * 1000);
  window.addEventListener('resize', () => { if (chart) chart.resize(); });
  setInterval(() => {
    const pref = localStorage.getItem(THEME_KEY) || 'auto';
    if (pref === 'auto') applyTheme('auto');
  }, 5 * 60 * 1000);

  const buildTag = document.getElementById('uiVersion');
  if (buildTag) {
    const stamp = document.lastModified ? new Date(document.lastModified) : new Date();
    const stampText = isNaN(stamp.getTime()) ? '-' : stamp.toLocaleString();
    buildTag.textContent = `UI v2 Â· ${stampText}`;
  }
</script>
</body>
</html>
