<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#0b1220; --panel:#0f1b33; --muted:#8aa0c7; --text:#e8f0ff;
      --ok:#2ecc71; --warn:#f1c40f; --bad:#e74c3c;
      --border:rgba(255,255,255,.08);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      background:linear-gradient(180deg,#070c16 0%, #0b1220 40%, #070c16 100%);
      color:var(--text);
    }
    a{ color:#9dd1ff; text-decoration:none; }
    .wrap{ max-width:1100px; margin:0 auto; padding:18px; }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
    }
    .logo{
      width:36px;height:36px;border-radius:10px;
      background:linear-gradient(135deg,#2d9cff,#8a5cff);
      box-shadow:0 10px 25px rgba(45,156,255,.25);
    }
    .title{
      font-size:18px; font-weight:700; letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted); font-size:12px; margin-top:2px;
    }
    .actions{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      transition:.15s;
      font-weight:600;
      font-size:13px;
    }
    .btn:hover{ background:rgba(255,255,255,.10); }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,.15);
      font-weight:700;
      font-size:13px;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--ok); box-shadow:0 0 0 3px rgba(46,204,113,.15); }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media(max-width:860px){ .grid{ grid-template-columns:1fr; } }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .card h3{
      margin:0 0 8px 0;
      font-size:14px;
      color:#cfe3ff;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .muted{ color:var(--muted); font-size:12px; }
    .imgwrap{ display:flex; gap:10px; flex-wrap:wrap; }
    .imgwrap img{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:#0b1220;
    }
    .img-half{ width:calc(50% - 5px); }
    @media(max-width:860px){ .img-half{ width:100%; } }

    .footer{ margin-top:12px; color:var(--muted); font-size:12px; text-align:center; opacity:.85; }

    /* modal */
    .mask{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.55);
      align-items:center; justify-content:center; padding:14px;
      z-index:999;
    }
    .modal{
      width:420px; max-width:100%;
      border-radius:16px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(15,27,51,.95), rgba(15,27,51,.88));
      box-shadow:0 18px 45px rgba(0,0,0,.45);
      padding:14px;
    }
    .modal h4{ margin:0 0 10px 0; font-size:14px; }
    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }
    label{ display:block; color:#cfe3ff; font-size:12px; margin:8px 0 6px; }
    input{
      width:100%;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
    }
    .modal .actions2{ display:flex; gap:10px; margin-top:12px; }
    .hint{ margin-top:10px; color:var(--muted); font-size:12px; line-height:1.4; }
    .kbd{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; background:rgba(255,255,255,.06); border:1px solid var(--border); padding:1px 6px; border-radius:8px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">vnStat Web Panel</div>
          <div class="subtitle">流量图表与摘要（PNG / JSON）</div>
        </div>
      </div>

      <div class="actions">
        <span class="pill" id="statusPill"><span class="dot" id="statusDot"></span><span id="statusText">运行中</span></span>
        <span class="pill" id="quotaPill" title="从 vnstat.json 读取本月总量（rx+tx）计算">
          本月：<span id="monthUsage">-</span> / <span id="monthQuota">-</span>（<span id="monthPct">-</span>）
        </span>
        <button class="btn" id="btnQuota" type="button">阈值设置</button>
        <button class="btn" id="btnTheme" type="button">主题</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>
          <span>小时（hourly.png）</span>
          <span class="muted" id="clock1">--</span>
        </h3>
        <div class="imgwrap">
          <img id="imgHourly" src="hourly.png" alt="hourly" />
        </div>
      </div>

      <div class="card">
        <h3>
          <span>日（daily.png）</span>
          <span class="muted" id="clock2">--</span>
        </h3>
        <div class="imgwrap">
          <img id="imgDaily" src="daily.png" alt="daily" />
        </div>
      </div>

      <div class="card">
        <h3>
          <span>月（monthly.png）</span>
          <span class="muted" id="clock3">--</span>
        </h3>
        <div class="imgwrap">
          <img id="imgMonthly" src="monthly.png" alt="monthly" />
        </div>
      </div>

      <div class="card">
        <h3>
          <span>摘要（summary.txt）</span>
          <span class="muted" id="clock4">--</span>
        </h3>
        <pre id="summaryBox" style="margin:0; white-space:pre-wrap; color:#cfe3ff; background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); padding:12px; border-radius:14px; min-height:190px;"></pre>
        <div class="muted" style="margin-top:8px;">数据来源：vnStat ｜ 建议后台 5 分钟更新 vnstat_5min.json / vnstat.json</div>
      </div>
    </div>

    <div class="footer">
      <span class="muted">提示：访问路径推荐使用</span>
      <span class="kbd">/vnstat/</span>
      <span class="muted">（通过 lighttpd alias.url 映射）</span>
    </div>
  </div>

  <!-- quota modal -->
  <div class="mask" id="quotaMask">
    <div class="modal" role="dialog" aria-modal="true">
      <h4>阈值设置</h4>

      <div class="row">
        <div>
          <label>月额度（GB）</label>
          <input id="q_quota_gb" type="number" min="1" step="1" value="1024" />
        </div>
        <div>
          <label>告警阈值（%）</label>
          <input id="q_alert_pct" type="number" min="1" max="100" step="1" value="90" />
        </div>
      </div>

      <label>危险阈值（%）</label>
      <input id="q_danger_pct" type="number" min="1" max="100" step="1" value="100" />

      <div class="actions2">
        <button class="btn" id="btnQuotaSave" type="button">保存</button>
        <button class="btn" id="btnQuotaCancel" type="button">取消</button>
      </div>

      <div class="hint" id="quotaHint">-</div>
    </div>
  </div>

  <script>
    // ========== theme ==========
    const THEME_KEY = 'vnstat_theme_v1';
    function applyTheme(mode){
      if(mode === 'light'){
        document.documentElement.style.setProperty('--bg','#f4f7ff');
        document.documentElement.style.setProperty('--panel','#ffffff');
        document.documentElement.style.setProperty('--text','#0b1220');
        document.documentElement.style.setProperty('--muted','#526a95');
        document.body.style.background = 'linear-gradient(180deg,#f8fbff 0%, #eef4ff 40%, #f8fbff 100%)';
      }else{
        document.documentElement.style.setProperty('--bg','#0b1220');
        document.documentElement.style.setProperty('--panel','#0f1b33');
        document.documentElement.style.setProperty('--text','#e8f0ff');
        document.documentElement.style.setProperty('--muted','#8aa0c7');
        document.body.style.background = 'linear-gradient(180deg,#070c16 0%, #0b1220 40%, #070c16 100%)';
      }
    }
    function initTheme(){
      const pref = localStorage.getItem(THEME_KEY) || 'auto';
      if(pref === 'auto'){
        const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(isDark ? 'dark' : 'light');
      }else{
        applyTheme(pref);
      }
    }
    document.getElementById('btnTheme').onclick = () => {
      const pref = localStorage.getItem(THEME_KEY) || 'auto';
      const next = pref === 'auto' ? 'dark' : (pref === 'dark' ? 'light' : 'auto');
      localStorage.setItem(THEME_KEY, next);
      if(next === 'auto'){
        const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        applyTheme(isDark ? 'dark' : 'light');
      }else{
        applyTheme(next);
      }
      setStatusText();
    };
    function setStatusText(){
      const pref = localStorage.getItem(THEME_KEY) || 'auto';
      document.getElementById('btnTheme').textContent = '主题：' + pref;
    }

    // ========== images / summary ==========
    function bust(url){ return url + (url.includes('?') ? '&' : '?') + '_=' + Date.now(); }
    function refreshImages(){
      document.getElementById('imgHourly').src = bust('hourly.png');
      document.getElementById('imgDaily').src  = bust('daily.png');
      document.getElementById('imgMonthly').src= bust('monthly.png');
    }
    async function refreshSummary(){
      try{
        const r = await fetch(bust('summary.txt'), { cache:'no-store' });
        document.getElementById('summaryBox').textContent = r.ok ? (await r.text()) : ('读取失败：HTTP ' + r.status);
      }catch(e){
        document.getElementById('summaryBox').textContent = '读取失败：' + (e.message || e);
      }
    }
    async function refreshClocks(){
      try{
        const r = await fetch(bust('server_time.json'), { cache:'no-store' });
        if(!r.ok) throw new Error('HTTP ' + r.status);
        const j = await r.json();
        const t = j.server_time || j.time || '';
        document.getElementById('clock1').textContent = t;
        document.getElementById('clock2').textContent = t;
        document.getElementById('clock3').textContent = t;
        document.getElementById('clock4').textContent = t;
      }catch(_){}
    }

    // ========== status ==========
    function setStatus(level, text){
      const dot = document.getElementById('statusDot');
      dot.style.background = (level==='bad') ? 'var(--bad)' : (level==='warn' ? 'var(--warn)' : 'var(--ok)');
      dot.style.boxShadow = (level==='bad') ? '0 0 0 3px rgba(231,76,60,.18)'
        : (level==='warn') ? '0 0 0 3px rgba(241,196,15,.18)'
        : '0 0 0 3px rgba(46,204,113,.18)';
      document.getElementById('statusText').textContent = text;
    }

    // ========== vnstat quota (legacy CGI) ==========
    // CGI 入口（lighttpd 默认 /cgi-bin/）
    const CGI_URL = "/cgi-bin/vnstat-web-config.cgi";

    async function cgiGetQuota(){
      const r = await fetch(CGI_URL + '?_=' + Date.now(), { cache: 'no-store' });
      if(!r.ok) throw new Error('CGI HTTP ' + r.status);
      return await r.json();
    }
    async function cgiSaveQuota(quota_gb, alert_pct, danger_pct){
      const body = new URLSearchParams();
      body.set('quota_gb', quota_gb);
      body.set('alert_pct', alert_pct);
      body.set('danger_pct', danger_pct);
      const r = await fetch(CGI_URL + '?' + body.toString() + '&_=' + Date.now(), { method: 'GET', cache: 'no-store' });
      if(!r.ok) throw new Error('CGI HTTP ' + r.status);
      return await r.json();
    }

    function bytesToGB(bytes){ return (Number(bytes)||0) / 1024 / 1024 / 1024; }

    function getMonthTotalBytes(vn){
      const iface = (vn.interfaces && vn.interfaces[0]) ? vn.interfaces[0] : null;
      if(!iface || !iface.traffic) return null;

      const monthArr = iface.traffic.month || iface.traffic.months || null;
      if(Array.isArray(monthArr) && monthArr.length){
        const sorted = [...monthArr].sort((a,b)=>{
          const ay=(a.date?.year||0), am=(a.date?.month||0);
          const by=(b.date?.year||0), bm=(b.date?.month||0);
          return (ay*100+am) - (by*100+bm);
        });
        const last = sorted[sorted.length-1];
        const rx = last.rx ?? last.rx_bytes ?? 0;
        const tx = last.tx ?? last.tx_bytes ?? 0;
        return (Number(rx)||0) + (Number(tx)||0);
      }
      return null;
    }

    async function refreshQuotaAlarm(){
      let settings;
      try{
        settings = await cgiGetQuota();
      }catch(_){
        // fallback
        settings = { quota_gb:1024, alert_pct:90, danger_pct:100 };
      }
      const quotaGb = Number(settings.quota_gb)||1024;
      const alertPct = Number(settings.alert_pct)||90;
      const dangerPct = Number(settings.danger_pct)||100;

      document.getElementById("monthQuota").textContent = quotaGb + "GB";

      try{
        const r = await fetch('vnstat.json?_=' + Date.now());
        if(!r.ok) throw new Error('vnstat.json HTTP ' + r.status);
        const vn = await r.json();

        const totalBytes = getMonthTotalBytes(vn);
        if(totalBytes == null){
          document.getElementById('monthUsage').textContent = '无本月数据';
          document.getElementById('monthPct').textContent = '-';
          setStatus('ok', '运行中');
          return;
        }

        const usedGB = bytesToGB(totalBytes);
        const pct = (usedGB / quotaGb) * 100;

        document.getElementById('monthUsage').textContent = usedGB.toFixed(2) + 'GB';
        document.getElementById('monthPct').textContent = isFinite(pct) ? pct.toFixed(1) + '%' : '-';

        if (isFinite(pct) && pct >= dangerPct){
          setStatus('bad', '危险：流量接近/超过额度');
        } else if (isFinite(pct) && pct >= alertPct){
          setStatus('warn', '告警：流量接近额度');
        } else {
          setStatus('ok', '运行中');
        }

        document.getElementById('quotaPill').title =
          `已用 ${usedGB.toFixed(2)}GB / ${quotaGb}GB（${pct.toFixed(1)}%） 告警>=${alertPct}% 危险>=${dangerPct}%`;

      }catch(e){
        document.getElementById('monthUsage').textContent = '读取失败';
        document.getElementById('monthPct').textContent = '-';
      }
    }

    // 弹窗
    function openQuotaModal(){
      document.getElementById('quotaHint').textContent = '读取服务器设置中...';
      document.getElementById('quotaMask').style.display = 'flex';

      cgiGetQuota().then(s=>{
        document.getElementById('q_quota_gb').value = Number(s.quota_gb)||1024;
        document.getElementById('q_alert_pct').value = Number(s.alert_pct)||90;
        document.getElementById('q_danger_pct').value = Number(s.danger_pct)||100;
        document.getElementById('quotaHint').innerHTML =
          '保存后：<b>黄灯=告警</b>，<b>红灯=危险</b>。设置由服务器 CGI 保存（不需要 token）。';
      }).catch(()=>{
        document.getElementById('quotaHint').textContent =
          '读取失败：CGI 不可用（检查 lighttpd cgi 模块和 /usr/lib/cgi-bin 权限）';
      });
    }
    function closeQuotaModal(){ document.getElementById('quotaMask').style.display = 'none'; }

    document.getElementById('btnQuota').onclick = openQuotaModal;
    document.getElementById('btnQuotaCancel').onclick = closeQuotaModal;
    document.getElementById('quotaMask').onclick = (e) => {
      if (e.target === document.getElementById('quotaMask')) closeQuotaModal();
    };

    document.getElementById('btnQuotaSave').onclick = async () => {
      const quota_gb = Math.max(1, Number(document.getElementById('q_quota_gb').value || 0));
      const alert_pct = Math.min(100, Math.max(1, Number(document.getElementById('q_alert_pct').value || 0)));
      const danger_pct0 = Math.min(100, Math.max(1, Number(document.getElementById('q_danger_pct').value || 0)));
      const danger_pct = Math.max(danger_pct0, alert_pct);

      try{
        await cgiSaveQuota(quota_gb, alert_pct, danger_pct);
        closeQuotaModal();
        await refreshQuotaAlarm();
      }catch(e){
        document.getElementById('quotaHint').textContent =
          '保存失败：' + (e.message || e);
      }
    };

    function tick(){
      refreshImages();
      refreshSummary();
      refreshClocks();
      refreshQuotaAlarm();
    }

    // 初始化
    initTheme();
    setStatusText();
    tick();

    setInterval(tick, 60 * 1000);
    setInterval(() => {
      const pref = localStorage.getItem(THEME_KEY) || 'auto';
      if (pref === 'auto') applyTheme('auto');
    }, 5 * 60 * 1000);
  </script>


<!-- VNSTAT_QUOTA_OVERRIDE_BEGIN -->
<script>
(function(){
  var KEY = 'vnstat_quota_settings_v1';
  var DEF = { quota_gb:1024, alert_pct:90, danger_pct:100 };
  function load(){
    try{
      var r = localStorage.getItem(KEY);
      if(!r) return DEF;
      var j = JSON.parse(r);
      var q = Number(j.quota_gb), a = Number(j.alert_pct), g = Number(j.danger_pct);
      return {
        quota_gb: (isFinite(q)&&q>0)?q:DEF.quota_gb,
        alert_pct: (isFinite(a)&&a>0&&a<=100)?a:DEF.alert_pct,
        danger_pct:(isFinite(g)&&g>0&&g<=100)?g:DEF.danger_pct
      };
    }catch(e){ return DEF; }
  }
  function save(q,a,g){
    localStorage.setItem(KEY, JSON.stringify({quota_gb:q,alert_pct:a,danger_pct:g}));
  }
  window.cgiGetQuota = async function(){ return load(); };
  window.cgiSaveQuota = async function(q,a,g){ save(q,a,g); return {ok:true}; };
})();
</script>
<!-- VNSTAT_QUOTA_OVERRIDE_END -->
</body>
</html>
